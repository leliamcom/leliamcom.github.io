{"author":{"avatar":"/assets/32x32_avatar.jpg","name":"Liam","tagline":"Make people great again!"},"data":"\nLast week we talked about how to make use pillar to create users in our master-less salt server. Today will be about how to use salt-formula and grains. [All SaltStack Article](https://www.leliam.com/tag/salt)\n\n## What is Salt Formulas\nFormulas are pre-written Salt States. All official Salt Formulas are found as separate Git repositories in the \"saltstack-formulas\" organization on GitHub: [https://github.com/saltstack-formulas](https://github.com/saltstack-formulas)\n\n## Objective\nThis week objective will be installing NodeJS 5.4.0 from binary with salt formula.\n\nThe standard way of installing salt-formula can be found at [https://docs.saltstack.com/en/latest/topics/development/conventions/formulas.html](https://docs.saltstack.com/en/latest/topics/development/conventions/formulas.html). However, I will use my own way here.\n\n## Server Structure\n~~~ ruby\n# vagrant sync folder\nconfig.vm.synced_folder \"salt/root/\", \"/srv/salt/\"\nconfig.vm.synced_folder \"salt/pillar/\", \"/srv/pillar/\"\n~~~\n\n~~~ ruby\n- /srv/\n  - pillar/  # Unlike state tree, pillar data is only available for the targeted minion specified by the matcher type.\n  - salt/  # All the configuration for the minion to run\n    - node/ # node formula folder\n~~~\n\n## Svn Export from Github\nMy favourite Github hack: (replacing tree/master with trunk)\n\n~~~ bash\ncd salt/root\nsvn export https://github.com/saltstack-formulas/node-formula/trunk/node\n~~~\n\n~~~ ruby\n#salt/root.top.sls\nbase:\n  '*':\n    - node\n~~~\n\n~~~ ruby\n# pillar/node/init.sls\nnode:\n  version: 5.4.0\n  checksum: f037e2734f52b9de63e6d4a4e80756477b843e6f106e0be05591a16b71ec2bd0\n  install_from_binary: True\n~~~\n\n~~~ ruby\n# pillar/top.sls\nbase:\n  '*':\n    - node\n~~~\n\nIf you try `salt-call --local state.highstate` you probably will get an error now. Why?\n\n## Grains\nSalt comes with an interface to derive information about the underlying system. This is called the grains interface, because it presents salt with grains of information. Grains are collected for the operating system, domain name, IP address, kernel, OS type, memory, and many other system properties.\n\nAs of the time I'm writing, [https://github.com/saltstack-formulas/node-formula/blob/master/node/map.jinja](https://github.com/saltstack-formulas/node-formula/blob/master/node/map.jinja) line 19-28 is missing CentOS config for the grains.os (most of saltstack formula comes with Ubuntu), so add Centos config\n\n~~~ ruby\n'Centos': {\n    'node_pkg': 'nodejs',\n    'npm_pkg': 'nodejs' if pillar_get('node:install_from_ppa') else 'npm',\n},\n~~~\n\nHow to see my os value is grains? Just run the script below can look for os, for me the value is CentOS\n~~~ ruby\nsudo salt-call --local grains.items\n~~~\n\nGrains can be customized in minion config file or at `/etc/salt/grains`, however normally using its default value is enough.\n\n## End Result\nIt should successfully install node version `5.4.0` and verify against checksum `f037e2734f52b9de6......`.\n\nNow run `salt-call --local state.highstate` and run `node -v` to verify, it should output `v5.4.0`.\n\n## This is it\nSo the basic concept of saltstack to work with masterless vagrant should be covered from part 1 to part 3. After knowing the basic concept it should be relatively easy to google search for salt related article and create a salt script that fits your need.\n    ","description":"\nLast week we talked about how to make use pillar to create users in our master-less salt server. Today will be about how to use salt-formula and grains. [All SaltStack Article](https://www.leliam.com/tag/salt)\n    ","id":"dfd8816b-5205-4468-ab70-a34ecaf68d96","bannerUrl":"/assets/2016011600.png","coverUrl":"/assets/thumb-150-2016011600.png","postedAt":"2016-01-29T16:00:00.000Z","slug":"saltstack-vagrant-part-3-@b6OoeoGspf0hA4TOO50PsfY","tags":["salt","configuration-management","vagrant"],"title":"SaltStack Vagrant Part 3","typeCode":1}