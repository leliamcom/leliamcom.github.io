<!doctype html> <html lang=en> <head> <meta charset=utf-8> <meta content="width=device-width,initial-scale=1" name=viewport> <meta content=#333333 name=theme-color> <base href=/ > <link href=css/global.css rel=stylesheet> <link href=manifest.json rel=manifest> <link href=favicon.ico rel=icon type=image/png> <link href=client/main.963202101.css rel=stylesheet><link href=client/[slug].674de79b.css rel=stylesheet><link href=client/app.89f7fc79.css rel=stylesheet><link href=client/Nav.036c21e8.css rel=stylesheet> <noscript id=sapper-head-start></noscript><title>SaltStack Vagrant Part 3</title> <meta content="Author: Liam, Date: 30 Jan, 2016\n Last week we talked about how to make use pillar to create users in our master-less salt server. Today will be about how to use salt-formula and grains. All SaltStack Article
" name=description> <meta content=article name=og:type> <meta content=https://leliam.com/blogposts/saltstack-vagrant-part-3-@6OoeoGspf0hA4TOO50PsfY name=og:url> <meta content="SaltStack Vagrant Part 3" name=og:title> <meta content="Last week we talked about how to make use pillar to create users in our master-less salt server. Today will be about how to use salt-formula and grains. All SaltStack Article\n" name=og:description><noscript id=sapper-head-end></noscript> </head> <body> <div id=sapper> <div style="min-height:calc(100vh - 48px)"> <nav aria-label="main navigation" class="svelte-1dif8ux navbar" role=navigation> <div class=navbar-brand> <a href=/ class="svelte-1dif8ux navbar-item" style=margin:5px><div class="is-4 subtitle">Le Liam</div></a> <a href=/ class="svelte-1dif8ux navbar-item">Home</a> <a href=/tags class="svelte-1dif8ux navbar-item">Tags</a> <a href=/blogposts class="svelte-1dif8ux navbar-item is-active">Blogposts</a> <a href=/contact class="svelte-1dif8ux navbar-item">Contact</a> </div> </nav> <main> <div class="container is-fluid"> <div class=media style="margin:25px 0"> <div class=media-left> <figure class="image is-48x48"> <img alt="Author avatar" loading=lazy src=/assets/32x32_avatar.jpg class=is-rounded> </figure> </div> <div class=media-content> <p class="is-4 title">Liam</p> <p class="subtitle is-6">30 Jan, 2016</p> </div> </div> <div style="margin:0 0 25px"> <img alt="blogpost banner" loading=lazy src=/assets/2016011600.png style="margin:0 auto;display:block"> </div> <h3 class=title>SaltStack Vagrant Part 3</h3> <div class="content svelte-nn94v0"> <p>Last week we talked about how to make use pillar to create users in our master-less salt server. Today will be about how to use salt-formula and grains. <a href=https://www.leliam.com/tag/salt>All SaltStack Article</a></p> <h2>What is Salt Formulas</h2> <p>Formulas are pre-written Salt States. All official Salt Formulas are found as separate Git repositories in the "saltstack-formulas" organization on GitHub: <a href=https://github.com/saltstack-formulas>https://github.com/saltstack-formulas</a></p> <h2>Objective</h2> <p>This week objective will be installing NodeJS 5.4.0 from binary with salt formula.</p> <p>The standard way of installing salt-formula can be found at <a href=https://docs.saltstack.com/en/latest/topics/development/conventions/formulas.html>https://docs.saltstack.com/en/latest/topics/development/conventions/formulas.html</a>. However, I will use my own way here.</p> <h2>Server Structure</h2> <pre class=hljs><code># vagrant sync folder
config.vm.synced_folder "salt/root/", "/srv/salt/"
config.vm.synced_folder "salt/pillar/", "/srv/pillar/"
</code></pre> <pre class=hljs><code>- /srv/
  - pillar/  # Unlike state tree, pillar data is only available for the targeted minion specified by the matcher type.
  - salt/  # All the configuration for the minion to run
    - node/ # node formula folder
</code></pre> <h2>Svn Export from Github</h2> <p>My favourite Github hack: (replacing tree/master with trunk)</p> <pre class=hljs><code><span class=hljs-built_in>cd</span> salt/root
svn <span class=hljs-built_in>export</span> https://github.com/saltstack-formulas/node-formula/trunk/node
</code></pre> <pre class=hljs><code>#salt/root.top.sls
base:
  '*':
    - node
</code></pre> <pre class=hljs><code># pillar/node/init.sls
node:
  version: 5.4.0
  checksum: f037e2734f52b9de63e6d4a4e80756477b843e6f106e0be05591a16b71ec2bd0
  install_from_binary: True
</code></pre> <pre class=hljs><code># pillar/top.sls
base:
  '*':
    - node
</code></pre> <p>If you try <code>salt-call --local state.highstate</code> you probably will get an error now. Why?</p> <h2>Grains</h2> <p>Salt comes with an interface to derive information about the underlying system. This is called the grains interface, because it presents salt with grains of information. Grains are collected for the operating system, domain name, IP address, kernel, OS type, memory, and many other system properties.</p> <p>As of the time I'm writing, <a href=https://github.com/saltstack-formulas/node-formula/blob/master/node/map.jinja>https://github.com/saltstack-formulas/node-formula/blob/master/node/map.jinja</a> line 19-28 is missing CentOS config for the grains.os (most of saltstack formula comes with Ubuntu), so add Centos config</p> <pre class=hljs><code>'Centos': {
    'node_pkg': 'nodejs',
    'npm_pkg': 'nodejs' if pillar_get('node:install_from_ppa') else 'npm',
},
</code></pre> <p>How to see my os value is grains? Just run the script below can look for os, for me the value is CentOS</p> <pre class=hljs><code>sudo salt-call --local grains.items
</code></pre> <p>Grains can be customized in minion config file or at <code>/etc/salt/grains</code>, however normally using its default value is enough.</p> <h2>End Result</h2> <p>It should successfully install node version <code>5.4.0</code> and verify against checksum <code>f037e2734f52b9de6......</code>.</p> <p>Now run <code>salt-call --local state.highstate</code> and run <code>node -v</code> to verify, it should output <code>v5.4.0</code>.</p> <h2>This is it</h2> <p>So the basic concept of saltstack to work with masterless vagrant should be covered from part 1 to part 3. After knowing the basic concept it should be relatively easy to google search for salt related article and create a salt script that fits your need.</p> </div> </div> </main> </div> <footer style=height:48px;padding:10px> <div class="content has-text-centered"> <a href=/privacy-policy>privacy policy</a> · ©2018-2020 Le Liam · <a href=/terms-of-service>TOS</a> </div> </footer></div> <script crossorigin=anonymous src="https://polyfill.io/v3/polyfill.min.js?features=fetch%2CPromise"></script> <script>__SAPPER__={baseUrl:"",preloaded:[void 0,null,{post:{slug:"saltstack-vagrant-part-3-@6OoeoGspf0hA4TOO50PsfY",title:"SaltStack Vagrant Part 3",description:"\u003Cp\u003ELast week we talked about how to make use pillar to create users in our master-less salt server. Today will be about how to use salt-formula and grains. \u003Ca href=\"https:\u002F\u002Fwww.leliam.com\u002Ftag\u002Fsalt\"\u003EAll SaltStack Article\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n",banner:"\u002Fassets\u002F2016011600.png",author:{avatar:"\u002Fassets\u002F32x32_avatar.jpg",name:"Liam"},data:"\u003Cp\u003ELast week we talked about how to make use pillar to create users in our master-less salt server. Today will be about how to use salt-formula and grains. \u003Ca href=\"https:\u002F\u002Fwww.leliam.com\u002Ftag\u002Fsalt\"\u003EAll SaltStack Article\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\u003Ch2\u003EWhat is Salt Formulas\u003C\u002Fh2\u003E\n\u003Cp\u003EFormulas are pre-written Salt States. All official Salt Formulas are found as separate Git repositories in the &quot;saltstack-formulas&quot; organization on GitHub: \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fsaltstack-formulas\"\u003Ehttps:\u002F\u002Fgithub.com\u002Fsaltstack-formulas\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\u003Ch2\u003EObjective\u003C\u002Fh2\u003E\n\u003Cp\u003EThis week objective will be installing NodeJS 5.4.0 from binary with salt formula.\u003C\u002Fp\u003E\n\u003Cp\u003EThe standard way of installing salt-formula can be found at \u003Ca href=\"https:\u002F\u002Fdocs.saltstack.com\u002Fen\u002Flatest\u002Ftopics\u002Fdevelopment\u002Fconventions\u002Fformulas.html\"\u003Ehttps:\u002F\u002Fdocs.saltstack.com\u002Fen\u002Flatest\u002Ftopics\u002Fdevelopment\u002Fconventions\u002Fformulas.html\u003C\u002Fa\u003E. However, I will use my own way here.\u003C\u002Fp\u003E\n\u003Ch2\u003EServer Structure\u003C\u002Fh2\u003E\n\u003Cpre class=\"hljs\"\u003E\u003Ccode\u003E# vagrant sync folder\nconfig.vm.synced_folder &quot;salt\u002Froot\u002F&quot;, &quot;\u002Fsrv\u002Fsalt\u002F&quot;\nconfig.vm.synced_folder &quot;salt\u002Fpillar\u002F&quot;, &quot;\u002Fsrv\u002Fpillar\u002F&quot;\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cpre class=\"hljs\"\u003E\u003Ccode\u003E- \u002Fsrv\u002F\n  - pillar\u002F  # Unlike state tree, pillar data is only available for the targeted minion specified by the matcher type.\n  - salt\u002F  # All the configuration for the minion to run\n    - node\u002F # node formula folder\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Ch2\u003ESvn Export from Github\u003C\u002Fh2\u003E\n\u003Cp\u003EMy favourite Github hack: (replacing tree\u002Fmaster with trunk)\u003C\u002Fp\u003E\n\u003Cpre class=\"hljs\"\u003E\u003Ccode\u003E\u003Cspan class=\"hljs-built_in\"\u003Ecd\u003C\u002Fspan\u003E salt\u002Froot\nsvn \u003Cspan class=\"hljs-built_in\"\u003Eexport\u003C\u002Fspan\u003E https:\u002F\u002Fgithub.com\u002Fsaltstack-formulas\u002Fnode-formula\u002Ftrunk\u002Fnode\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cpre class=\"hljs\"\u003E\u003Ccode\u003E#salt\u002Froot.top.sls\nbase:\n  '*':\n    - node\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cpre class=\"hljs\"\u003E\u003Ccode\u003E# pillar\u002Fnode\u002Finit.sls\nnode:\n  version: 5.4.0\n  checksum: f037e2734f52b9de63e6d4a4e80756477b843e6f106e0be05591a16b71ec2bd0\n  install_from_binary: True\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cpre class=\"hljs\"\u003E\u003Ccode\u003E# pillar\u002Ftop.sls\nbase:\n  '*':\n    - node\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EIf you try \u003Ccode\u003Esalt-call --local state.highstate\u003C\u002Fcode\u003E you probably will get an error now. Why?\u003C\u002Fp\u003E\n\u003Ch2\u003EGrains\u003C\u002Fh2\u003E\n\u003Cp\u003ESalt comes with an interface to derive information about the underlying system. This is called the grains interface, because it presents salt with grains of information. Grains are collected for the operating system, domain name, IP address, kernel, OS type, memory, and many other system properties.\u003C\u002Fp\u003E\n\u003Cp\u003EAs of the time I'm writing, \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fsaltstack-formulas\u002Fnode-formula\u002Fblob\u002Fmaster\u002Fnode\u002Fmap.jinja\"\u003Ehttps:\u002F\u002Fgithub.com\u002Fsaltstack-formulas\u002Fnode-formula\u002Fblob\u002Fmaster\u002Fnode\u002Fmap.jinja\u003C\u002Fa\u003E line 19-28 is missing CentOS config for the grains.os (most of saltstack formula comes with Ubuntu), so add Centos config\u003C\u002Fp\u003E\n\u003Cpre class=\"hljs\"\u003E\u003Ccode\u003E'Centos': {\n    'node_pkg': 'nodejs',\n    'npm_pkg': 'nodejs' if pillar_get('node:install_from_ppa') else 'npm',\n},\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EHow to see my os value is grains? Just run the script below can look for os, for me the value is CentOS\u003C\u002Fp\u003E\n\u003Cpre class=\"hljs\"\u003E\u003Ccode\u003Esudo salt-call --local grains.items\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EGrains can be customized in minion config file or at \u003Ccode\u003E\u002Fetc\u002Fsalt\u002Fgrains\u003C\u002Fcode\u003E, however normally using its default value is enough.\u003C\u002Fp\u003E\n\u003Ch2\u003EEnd Result\u003C\u002Fh2\u003E\n\u003Cp\u003EIt should successfully install node version \u003Ccode\u003E5.4.0\u003C\u002Fcode\u003E and verify against checksum \u003Ccode\u003Ef037e2734f52b9de6......\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\n\u003Cp\u003ENow run \u003Ccode\u003Esalt-call --local state.highstate\u003C\u002Fcode\u003E and run \u003Ccode\u003Enode -v\u003C\u002Fcode\u003E to verify, it should output \u003Ccode\u003Ev5.4.0\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\n\u003Ch2\u003EThis is it\u003C\u002Fh2\u003E\n\u003Cp\u003ESo the basic concept of saltstack to work with masterless vagrant should be covered from part 1 to part 3. After knowing the basic concept it should be relatively easy to google search for salt related article and create a salt script that fits your need.\u003C\u002Fp\u003E\n",postedAt:"30 Jan, 2016",metaDescription:"Last week we talked about how to make use pillar to create users in our master-less salt server. Today will be about how to use salt-formula and grains. All SaltStack Article\n"}}]};if('serviceWorker' in navigator)navigator.serviceWorker.register('/service-worker.js');(function(){try{eval("async function x(){}");var main="/client/client.999f4b1a.js"}catch(e){main="/client/legacy/client.47155375.js"};var s=document.createElement("script");try{new Function("if(0)import('')")();s.src=main;s.type="module";s.crossOrigin="use-credentials";}catch(e){s.src="/client/shimport@1.0.1.js";s.setAttribute("data-main",main);}document.head.appendChild(s);}());</script> <script> function trim(text, val) {
		return text.replace(new RegExp('^'+val+'+|'+val+'+$','g'), '');
	}
	if (document.title === "Not Found") {
		let paths = trim(window.location.pathname, "/").split("-@");
		if (paths.length > 1) {
			fetch(`/blogposts/shortener-${paths[paths.length - 1]}.json`)
			.then((data) => {
				return data.json()
			})
			.then((data) => {
				window.location.replace(`/blogposts/${data.slug}`);
			})
			.catch((err) => {
				console.log(err);
			})
		}
	} </script> 