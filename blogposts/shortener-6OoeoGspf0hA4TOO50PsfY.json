{"slug":"saltstack-vagrant-part-3-@6OoeoGspf0hA4TOO50PsfY","title":"SaltStack Vagrant Part 3","description":"<p>Last week we talked about how to make use pillar to create users in our master-less salt server. Today will be about how to use salt-formula and grains. <a href=\"https://www.leliam.com/tag/salt\">All SaltStack Article</a></p>\n","banner":"/assets/2016011600.png","author":{"avatar":"/assets/32x32_avatar.jpg","name":"Liam"},"data":"<p>Last week we talked about how to make use pillar to create users in our master-less salt server. Today will be about how to use salt-formula and grains. <a href=\"https://www.leliam.com/tag/salt\">All SaltStack Article</a></p>\n<h2>What is Salt Formulas</h2>\n<p>Formulas are pre-written Salt States. All official Salt Formulas are found as separate Git repositories in the &quot;saltstack-formulas&quot; organization on GitHub: <a href=\"https://github.com/saltstack-formulas\">https://github.com/saltstack-formulas</a></p>\n<h2>Objective</h2>\n<p>This week objective will be installing NodeJS 5.4.0 from binary with salt formula.</p>\n<p>The standard way of installing salt-formula can be found at <a href=\"https://docs.saltstack.com/en/latest/topics/development/conventions/formulas.html\">https://docs.saltstack.com/en/latest/topics/development/conventions/formulas.html</a>. However, I will use my own way here.</p>\n<h2>Server Structure</h2>\n<pre class=\"hljs\"><code># vagrant sync folder\nconfig.vm.synced_folder &quot;salt/root/&quot;, &quot;/srv/salt/&quot;\nconfig.vm.synced_folder &quot;salt/pillar/&quot;, &quot;/srv/pillar/&quot;\n</code></pre>\n<pre class=\"hljs\"><code>- /srv/\n  - pillar/  # Unlike state tree, pillar data is only available for the targeted minion specified by the matcher type.\n  - salt/  # All the configuration for the minion to run\n    - node/ # node formula folder\n</code></pre>\n<h2>Svn Export from Github</h2>\n<p>My favourite Github hack: (replacing tree/master with trunk)</p>\n<pre class=\"hljs\"><code><span class=\"hljs-built_in\">cd</span> salt/root\nsvn <span class=\"hljs-built_in\">export</span> https://github.com/saltstack-formulas/node-formula/trunk/node\n</code></pre>\n<pre class=\"hljs\"><code>#salt/root.top.sls\nbase:\n  '*':\n    - node\n</code></pre>\n<pre class=\"hljs\"><code># pillar/node/init.sls\nnode:\n  version: 5.4.0\n  checksum: f037e2734f52b9de63e6d4a4e80756477b843e6f106e0be05591a16b71ec2bd0\n  install_from_binary: True\n</code></pre>\n<pre class=\"hljs\"><code># pillar/top.sls\nbase:\n  '*':\n    - node\n</code></pre>\n<p>If you try <code>salt-call --local state.highstate</code> you probably will get an error now. Why?</p>\n<h2>Grains</h2>\n<p>Salt comes with an interface to derive information about the underlying system. This is called the grains interface, because it presents salt with grains of information. Grains are collected for the operating system, domain name, IP address, kernel, OS type, memory, and many other system properties.</p>\n<p>As of the time I'm writing, <a href=\"https://github.com/saltstack-formulas/node-formula/blob/master/node/map.jinja\">https://github.com/saltstack-formulas/node-formula/blob/master/node/map.jinja</a> line 19-28 is missing CentOS config for the grains.os (most of saltstack formula comes with Ubuntu), so add Centos config</p>\n<pre class=\"hljs\"><code>'Centos': {\n    'node_pkg': 'nodejs',\n    'npm_pkg': 'nodejs' if pillar_get('node:install_from_ppa') else 'npm',\n},\n</code></pre>\n<p>How to see my os value is grains? Just run the script below can look for os, for me the value is CentOS</p>\n<pre class=\"hljs\"><code>sudo salt-call --local grains.items\n</code></pre>\n<p>Grains can be customized in minion config file or at <code>/etc/salt/grains</code>, however normally using its default value is enough.</p>\n<h2>End Result</h2>\n<p>It should successfully install node version <code>5.4.0</code> and verify against checksum <code>f037e2734f52b9de6......</code>.</p>\n<p>Now run <code>salt-call --local state.highstate</code> and run <code>node -v</code> to verify, it should output <code>v5.4.0</code>.</p>\n<h2>This is it</h2>\n<p>So the basic concept of saltstack to work with masterless vagrant should be covered from part 1 to part 3. After knowing the basic concept it should be relatively easy to google search for salt related article and create a salt script that fits your need.</p>\n","postedAt":"30 Jan, 2016","metaDescription":"Last week we talked about how to make use pillar to create users in our master-less salt server. Today will be about how to use salt-formula and grains. All SaltStack Article\n"}